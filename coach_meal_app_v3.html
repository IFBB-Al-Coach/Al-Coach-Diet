<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>وجبة الكوتش - إدارة المبيعات والتكاليف (مصحح)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #00897b; /* Teal 600 */
            --primary-light: #4db6ac; /* Teal 300 */
            --secondary-color: #ffb300; /* Amber 600 */
            --background-color: #f4f6f8; /* Light Gray */
            --surface-color: #ffffff;
            --text-color: #212121;
            --text-light: #757575;
            --border-color: #e0e0e0;
            --shadow-light: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 6px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background: var(--primary-color);
            color: var(--surface-color);
            padding: 15px 20px;
            text-align: center;
            box-shadow: var(--shadow-medium);
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        header p {
            margin: 5px 0 0;
            font-size: 0.9rem;
            color: var(--primary-light);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab-btn {
            flex-shrink: 0;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--surface-color);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-color);
            font-weight: 500;
        }

        .tab-btn:hover {
            background: var(--background-color);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: var(--surface-color);
            border-color: var(--primary-color);
            font-weight: 600;
            box-shadow: var(--shadow-light);
        }

        .section {
            display: none;
            background: var(--surface-color);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        h2 {
            font-size: 1.3rem;
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
        }

        h3 {
            font-size: 1.1rem;
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        label {
            display: block;
            font-size: 0.85rem;
            margin: 8px 0 4px;
            color: var(--text-light);
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            font-size: 0.9rem;
            box-sizing: border-box;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .row > div {
            flex: 1;
        }

        button.primary {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            border: none;
            border-radius: 6px;
            background: var(--primary-color);
            color: var(--surface-color);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s;
        }

        button.primary:hover {
            background: #00695c; /* Darker Teal */
        }

        button.primary:active {
            transform: scale(0.99);
        }

        button.secondary {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            background: var(--surface-color);
            color: var(--primary-color);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button.secondary:hover {
            background: var(--primary-color);
            color: var(--surface-color);
        }

        .summary-box {
            background: #e0f7fa; /* Light Cyan */
            border-left: 5px solid var(--primary-color);
            border-radius: 8px;
            padding: 15px;
            font-size: 0.9rem;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
        }

        .summary-box span {
            display: block;
            margin: 5px 0;
            font-weight: 500;
        }

        .summary-box strong {
            color: var(--primary-color);
            font-weight: 700;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 15px;
            background: var(--surface-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
        }

        th {
            background: var(--primary-color);
            color: var(--surface-color);
            font-weight: 600;
            white-space: nowrap;
        }

        tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        tfoot td {
            font-weight: 700;
            background: #e0e0e0;
            color: var(--text-color);
        }

        .footer {
            font-size: 0.8rem;
            text-align: center;
            padding: 15px;
            color: var(--text-light);
        }

        .footer a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .actions-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .actions-row button {
            flex: 1;
        }

        /* تحسينات إضافية */
        .alert-info {
            background: #fff3e0; /* Light Orange */
            color: #e65100; /* Dark Orange */
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-right: 4px solid #e65100;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

<header>
    <h1>وجبة الكوتش - نظام إدارة العمليات</h1>
    <p>دمشق – ساحة المحافظة | موبايل: +963-992223739 / +963-941404500</p>
</header>

<div class="container">

    <!-- تبويبات رئيسية -->
    <div class="tabs">
        <button class="tab-btn active" data-target="sales">تسجيل المبيعات اليومية</button>
        <button class="tab-btn" data-target="summary">ملخص الأداء اليومي</button>
        <button class="tab-btn" data-target="costs">إدارة التكاليف الثابتة</button>
        <button class="tab-btn" data-target="report">تقرير نهاية اليوم</button>
    </div>

    <!-- قسم المبيعات (الواجهة الأولى) -->
    <section id="sales" class="section active">
        <h2>تسجيل مبيعات الوجبات</h2>

        <div class="summary-box">
            <span>الإيجار الشهري الثابت: <strong>1,000,000</strong> ل.س</span>
            <span>الرواتب الشهرية الثابتة: <strong>1,400,000</strong> ل.س</span>
            <span>تكلفة الغاز الشهرية الثابتة: <strong>300,000</strong> ل.س</span>
            <span id="dailyFixedCostShare">حصة التكاليف الثابتة اليومية (تقديري): <strong>0</strong> ل.س</span>
        </div>

        <h3>إدارة قائمة الوجبات</h3>
        <div class="row">
            <div>
                <label for="mealName">اسم الوجبة</label>
                <input type="text" id="mealName" placeholder="مثال: وجبة دجاج مشوي">
            </div>
            <div>
                <label for="mealPrice">سعر البيع (ل.س)</label>
                <input type="number" id="mealPrice" placeholder="مثال: 50000" min="0">
            </div>
        </div>
        <div class="row">
            <div>
                <label for="mealMaterialCost">تكلفة المواد الأولية (ل.س)</label>
                <input type="number" id="mealMaterialCost" placeholder="مثال: 25000" min="0">
            </div>
            <div>
                <label for="mealNote">ملاحظة إضافية</label>
                <input type="text" id="mealNote" placeholder="مثال: وجبة عالية الربح">
            </div>
        </div>
        <button class="primary" onclick="addMeal()">إضافة / تحديث الوجبة</button>

        <table id="mealsTable">
            <thead>
                <tr>
                    <th>الوجبة</th>
                    <th>سعر البيع</th>
                    <th>تكلفة المواد</th>
                    <th>حصة التكاليف الثابتة</th>
                    <th>التكلفة الإجمالية للوجبة</th>
                    <th>ملاحظة</th>
                    <th>إجراء</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>تسجيل عملية بيع جديدة</h3>
        <label for="saleMealSelect">اختر الوجبة المباعة</label>
        <select id="saleMealSelect">
            <option value="">-- اختر وجبة --</option>
        </select>

        <div class="row">
            <div>
                <label for="customerType">نوع العميل</label>
                <select id="customerType">
                    <option value="صالة">صالة (داخل المطعم)</option>
                    <option value="موظف">موظف (خصم)</option>
                    <option value="خارجي">خارجي (تيك أواي)</option>
                </select>
            </div>
            <div>
                <label for="mealQty">الكمية المباعة</label>
                <input type="number" id="mealQty" value="1" min="1">
            </div>
        </div>

        <div class="row">
            <div>
                <label for="drinksValue">مبيعات المشروبات (ل.س)</label>
                <input type="number" id="drinksValue" value="0" min="0">
            </div>
            <div>
                <label for="deliveryValue">رسوم التوصيل (ل.س)</label>
                <input type="number" id="deliveryValue" value="0" min="0">
            </div>
        </div>

        <button class="primary" onclick="addSale()">تسجيل عملية البيع</button>

        <table id="salesTable">
            <thead>
                <tr>
                    <th>الوجبة</th>
                    <th>النوع</th>
                    <th>الكمية</th>
                    <th>إجمالي مبيعات الوجبات</th>
                    <th>مشروبات</th>
                    <th>توصيل</th>
                    <th>التكلفة الإجمالية</th>
                    <th>إجراء</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <td colspan="3">الإجماليات اليومية</td>
                    <td id="salesTotalMeals">0</td>
                    <td id="salesTotalDrinks">0</td>
                    <td id="salesTotalDelivery">0</td>
                    <td id="salesTotalFullCost">0</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </section>

    <!-- قسم ملخص الأداء اليومي -->
    <section id="summary" class="section">
        <h2>ملخص الأداء اليومي</h2>
        <div class="alert-info">
            هذا الملخص يعرض الأداء المالي حتى اللحظة بناءً على المبيعات المسجلة والتكاليف الثابتة.
        </div>

        <h3>ملخص الإيرادات والتكاليف</h3>
        <table id="summaryTable">
            <thead>
                <tr>
                    <th>البيان</th>
                    <th>القيمة (ل.س)</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>إجمالي مبيعات الوجبات</td><td id="sumTotalMeals">0</td></tr>
                <tr><td>إجمالي مبيعات المشروبات</td><td id="sumTotalDrinks">0</td></tr>
                <tr><td>إجمالي رسوم التوصيل</td><td id="sumTotalDelivery">0</td></tr>
                <tr><td><strong>إجمالي الإيرادات اليومية</strong></td><td id="sumTotalRevenue"><strong>0</strong></td></tr>
                <tr><td>تكلفة المواد الأولية للوجبات المباعة</td><td id="sumMaterialCost">0</td></tr>
                <tr><td>حصة التكاليف الثابتة اليومية</td><td id="sumFixedCostShare">0</td></tr>
                <tr><td><strong>إجمالي التكاليف اليومية</strong></td><td id="sumTotalCost"><strong>0</strong></td></tr>
            </tbody>
            <tfoot>
                <tr>
                    <td><strong>صافي الربح اليومي (قبل الضرائب)</strong></td>
                    <td id="sumNetProfit"><strong>0</strong></td>
                </tr>
            </tfoot>
        </table>

        <h3>تحليل المبيعات حسب الوجبة</h3>
        <table id="mealAnalysisTable">
            <thead>
                <tr>
                    <th>الوجبة</th>
                    <th>الكمية</th>
                    <th>الإيراد</th>
                    <th>الربح الإجمالي</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <!-- قسم إدارة التكاليف الثابتة -->
    <section id="costs" class="section">
        <h2>إدارة التكاليف الثابتة الشهرية</h2>
        <div class="alert-info">
            يتم استخدام هذه القيم لحساب حصة التكلفة الثابتة اليومية لكل وجبة (بافتراض 30 يوم عمل شهريًا).
        </div>

        <div class="row">
            <div>
                <label for="monthlyRent">الإيجار الشهري (ل.س)</label>
                <input type="number" id="monthlyRent" value="1000000" min="0">
            </div>
            <div>
                <label for="monthlySalaries">الرواتب الشهرية (ل.س)</label>
                <input type="number" id="monthlySalaries" value="1400000" min="0">
            </div>
        </div>
        <div class="row">
            <div>
                <label for="monthlyGas">تكلفة الغاز الشهرية (ل.س)</label>
                <input type="number" id="monthlyGas" value="300000" min="0">
            </div>
            <div>
                <label for="otherFixedCosts">تكاليف ثابتة أخرى (ل.س)</label>
                <input type="number" id="otherFixedCosts" value="0" min="0">
            </div>
        </div>
        <button class="primary" onclick="updateFixedCosts()">تحديث التكاليف الثابتة</button>

        <h3 style="margin-top: 30px;">التكاليف اليومية المتغيرة (المصروفات النثرية)</h3>
        <div class="row">
            <div>
                <label for="dailyExpenseDesc">وصف المصروف</label>
                <input type="text" id="dailyExpenseDesc" placeholder="مثال: صيانة بسيطة، مواد تنظيف">
            </div>
            <div>
                <label for="dailyExpenseAmount">المبلغ (ل.س)</label>
                <input type="number" id="dailyExpenseAmount" value="0" min="0">
            </div>
        </div>
        <button class="secondary" onclick="addDailyExpense()">إضافة مصروف يومي</button>

        <table id="dailyExpensesTable">
            <thead>
                <tr>
                    <th>الوصف</th>
                    <th>المبلغ (ل.س)</th>
                    <th>إجراء</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <td><strong>إجمالي المصروفات النثرية اليومية</strong></td>
                    <td id="totalDailyExpenses">0</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </section>

    <!-- قسم تقرير نهاية اليوم -->
    <section id="report" class="section">
        <h2>تقرير نهاية اليوم</h2>
        <div class="alert-info">
            هذا التقرير هو خلاصة شاملة لنتائج اليوم. يرجى مراجعته قبل إغلاق العمليات.
        </div>

        <h3>ملخص النتائج النهائية</h3>
        <table id="finalReportTable">
            <thead>
                <tr>
                    <th>البيان</th>
                    <th>القيمة (ل.س)</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>إجمالي الإيرادات (مبيعات + توصيل)</td><td id="repTotalRevenue">0</td></tr>
                <tr><td>إجمالي تكلفة المواد الأولية</td><td id="repMaterialCost">0</td></tr>
                <tr><td>إجمالي حصة التكاليف الثابتة اليومية</td><td id="repFixedCostShare">0</td></tr>
                <tr><td>إجمالي المصروفات النثرية اليومية</td><td id="repDailyExpenses">0</td></tr>
                <tr><td><strong>إجمالي التكاليف اليومية (مواد + ثابتة + نثرية)</strong></td><td id="repTotalCostFinal"><strong>0</strong></td></tr>
            </tbody>
            <tfoot>
                <tr>
                    <td><strong>صافي الربح النهائي لليوم</strong></td>
                    <td id="repNetProfitFinal"><strong>0</strong></td>
                </tr>
            </tfoot>
        </table>

        <h3 style="margin-top: 30px;">تفاصيل المبيعات</h3>
        <pre id="salesReportDetails" style="background:#f9f9f9; padding:10px; border:1px solid #eee; border-radius:6px; font-size:0.8rem;"></pre>

        <div class="actions-row">
            <button class="primary" onclick="generateReport()">تحديث التقرير النهائي</button>
            <button class="secondary" onclick="exportReport()">تصدير التقرير (نص)</button>
        </div>
    </section>

</div>

<div class="footer">
    <p>&copy; 2025 وجبة الكوتش. نظام إدارة العمليات. <a href="#">للتواصل والدعم</a></p>
</div>

<script>
    // ----------------------------------------------------------------
    // 1. تعريف البيانات الأساسية
    // ----------------------------------------------------------------
    let meals = JSON.parse(localStorage.getItem('meals')) || [];
    let sales = JSON.parse(localStorage.getItem('sales')) || [];
    let fixedCosts = JSON.parse(localStorage.getItem('fixedCosts')) || {
        rent: 1000000,
        salaries: 1400000,
        gas: 300000,
        other: 0
    };
    let dailyExpenses = JSON.parse(localStorage.getItem('dailyExpenses')) || [];
    const WORKING_DAYS_PER_MONTH = 30;

    // ----------------------------------------------------------------
    // 2. وظائف التخزين (Local Storage)
    // ----------------------------------------------------------------
    function saveMeals() { localStorage.setItem('meals', JSON.stringify(meals)); }
    function saveSales() { localStorage.setItem('sales', JSON.stringify(sales)); }
    function saveFixedCosts() { localStorage.setItem('fixedCosts', JSON.stringify(fixedCosts)); }
    function saveDailyExpenses() { localStorage.setItem('dailyExpenses', JSON.stringify(dailyExpenses)); }

    // ----------------------------------------------------------------
    // 3. وظائف حساب التكاليف
    // ----------------------------------------------------------------
    function calculateDailyFixedCostShare() {
        const totalMonthlyFixedCost = fixedCosts.rent + fixedCosts.salaries + fixedCosts.gas + fixedCosts.other;
        const dailyFixedCost = totalMonthlyFixedCost / WORKING_DAYS_PER_MONTH;
        return dailyFixedCost;
    }

    function calculateMealFixedCostShare() {
        const dailyFixedCost = calculateDailyFixedCostShare();
        // توزيع التكلفة الثابتة اليومية بالتساوي على عدد الوجبات المسجلة
        // هذا تبسيط، يمكن تحسينه لاحقاً ليتناسب مع حجم الوجبة أو سعرها
        const activeMealsCount = meals.length > 0 ? meals.length : 1;
        return dailyFixedCost / activeMealsCount;
    }

    function formatCurrency(number) {
        return new Intl.NumberFormat('ar-SY', { style: 'decimal' }).format(number);
    }

    // ----------------------------------------------------------------
    // 4. وظائف إدارة الوجبات (Meals)
    // ----------------------------------------------------------------
    function renderMealsTable() {
        const tableBody = document.querySelector('#mealsTable tbody');
        tableBody.innerHTML = '';
        const dailyFixedCost = calculateDailyFixedCostShare(); // تم إضافة هذا السطر
        const mealFixedCostShare = calculateMealFixedCostShare();

        meals.forEach((meal, index) => {
            const totalCost = meal.materialCost + mealFixedCostShare;
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${meal.name}</td>
                <td>${formatCurrency(meal.price)}</td>
                <td>${formatCurrency(meal.materialCost)}</td>
                <td>${formatCurrency(mealFixedCostShare)}</td>
                <td><strong>${formatCurrency(Math.round(totalCost))}</strong></td>
                <td>${meal.note || '-'}</td>
                <td><button class="secondary" style="width:auto;margin:0;" onclick="editMeal(${index})">تعديل</button></td>
            `;
        });

        // تحديث قائمة الوجبات في نموذج البيع
        const select = document.getElementById('saleMealSelect');
        select.innerHTML = '<option value="">-- اختر وجبة --</option>';
        meals.forEach(meal => {
            const option = document.createElement('option');
            option.value = meal.name;
            option.textContent = `${meal.name} (${formatCurrency(meal.price)} ل.س)`;
            select.appendChild(option);
        });

        // تحديث حصة التكاليف الثابتة في صندوق الملخص
        document.getElementById('dailyFixedCostShare').innerHTML = `حصة التكاليف الثابتة اليومية (تقديري): <strong>${formatCurrency(Math.round(dailyFixedCost))}</strong> ل.س`;
    }

    function addMeal() {
        const name = document.getElementById('mealName').value.trim();
        const price = parseInt(document.getElementById('mealPrice').value);
        const materialCost = parseInt(document.getElementById('mealMaterialCost').value);
        const note = document.getElementById('mealNote').value.trim();

        if (!name || isNaN(price) || price <= 0 || isNaN(materialCost) || materialCost < 0) {
            alert('يرجى إدخال اسم الوجبة وسعر البيع وتكلفة المواد بشكل صحيح.');
            return;
        }

        const existingIndex = meals.findIndex(m => m.name === name);
        const newMeal = { name, price, materialCost, note };

        if (existingIndex > -1) {
            meals[existingIndex] = newMeal;
            alert(`تم تحديث الوجبة: ${name}`);
        } else {
            meals.push(newMeal);
            alert(`تم إضافة الوجبة: ${name}`);
        }

        saveMeals();
        renderMealsTable();
        // مسح الحقول بعد الإضافة/التحديث
        document.getElementById('mealName').value = '';
        document.getElementById('mealPrice').value = '';
        document.getElementById('mealMaterialCost').value = '';
        document.getElementById('mealNote').value = '';
    }

    function editMeal(index) {
        const meal = meals[index];
        document.getElementById('mealName').value = meal.name;
        document.getElementById('mealPrice').value = meal.price;
        document.getElementById('mealMaterialCost').value = meal.materialCost;
        document.getElementById('mealNote').value = meal.note;
        // يمكن إضافة زر "حذف" هنا إذا لزم الأمر
    }

    // ----------------------------------------------------------------
    // 5. وظائف إدارة المبيعات (Sales)
    // ----------------------------------------------------------------
    function renderSalesTable() {
        const tableBody = document.querySelector('#salesTable tbody');
        tableBody.innerHTML = '';
        let totalMealsRevenue = 0;
        let totalDrinksRevenue = 0;
        let totalDeliveryRevenue = 0;
        let totalFullCost = 0;

        sales.forEach((sale, index) => {
            const meal = meals.find(m => m.name === sale.mealName);
            if (!meal) return; // تخطي إذا لم يتم العثور على الوجبة

            const mealFixedCostShare = calculateMealFixedCostShare();
            const singleMealTotalCost = meal.materialCost + mealFixedCostShare;
            const saleFullCost = singleMealTotalCost * sale.qty;

            totalMealsRevenue += meal.price * sale.qty;
            totalDrinksRevenue += sale.drinksValue;
            totalDeliveryRevenue += sale.deliveryValue;
            totalFullCost += saleFullCost;

            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${sale.mealName}</td>
                <td>${sale.customerType}</td>
                <td>${sale.qty}</td>
                <td>${formatCurrency(meal.price * sale.qty)}</td>
                <td>${formatCurrency(sale.drinksValue)}</td>
                <td>${formatCurrency(sale.deliveryValue)}</td>
                <td>${formatCurrency(Math.round(saleFullCost))}</td>
                <td><button class="secondary" style="width:auto;margin:0;" onclick="deleteSale(${index})">حذف</button></td>
            `;
        });

        document.getElementById('salesTotalMeals').textContent = formatCurrency(totalMealsRevenue);
        document.getElementById('salesTotalDrinks').textContent = formatCurrency(totalDrinksRevenue);
        document.getElementById('salesTotalDelivery').textContent = formatCurrency(totalDeliveryRevenue);
        document.getElementById('salesTotalFullCost').textContent = formatCurrency(Math.round(totalFullCost));
    }

    function addSale() {
        const mealName = document.getElementById('saleMealSelect').value;
        const customerType = document.getElementById('customerType').value;
        const qty = parseInt(document.getElementById('mealQty').value);
        const drinksValue = parseInt(document.getElementById('drinksValue').value) || 0;
        const deliveryValue = parseInt(document.getElementById('deliveryValue').value) || 0;

        if (!mealName || isNaN(qty) || qty <= 0) {
            alert('يرجى اختيار الوجبة وتحديد الكمية بشكل صحيح.');
            return;
        }

        const newSale = { mealName, customerType, qty, drinksValue, deliveryValue, timestamp: new Date().toISOString() };
        sales.push(newSale);
        saveSales();
        renderSalesTable();

        // مسح حقول البيع السريع
        document.getElementById('saleMealSelect').value = '';
        document.getElementById('mealQty').value = '1';
        document.getElementById('drinksValue').value = '0';
        document.getElementById('deliveryValue').value = '0';
    }

    function deleteSale(index) {
        if (confirm('هل أنت متأكد من حذف عملية البيع هذه؟')) {
            sales.splice(index, 1);
            saveSales();
            renderSalesTable();
        }
    }

    // ----------------------------------------------------------------
    // 6. وظائف إدارة التكاليف الثابتة والمصروفات اليومية
    // ----------------------------------------------------------------
    function updateFixedCosts() {
        fixedCosts.rent = parseInt(document.getElementById('monthlyRent').value) || 0;
        fixedCosts.salaries = parseInt(document.getElementById('monthlySalaries').value) || 0;
        fixedCosts.gas = parseInt(document.getElementById('monthlyGas').value) || 0;
        fixedCosts.other = parseInt(document.getElementById('otherFixedCosts').value) || 0;

        saveFixedCosts();
        alert('تم تحديث التكاليف الثابتة بنجاح.');
        // إعادة عرض الجداول لتحديث حصة التكلفة الثابتة
        renderMealsTable();
        renderSalesTable();
    }

    function renderFixedCosts() {
        document.getElementById('monthlyRent').value = fixedCosts.rent;
        document.getElementById('monthlySalaries').value = fixedCosts.salaries;
        document.getElementById('monthlyGas').value = fixedCosts.gas;
        document.getElementById('otherFixedCosts').value = fixedCosts.other;

        // تحديث صندوق الملخص في واجهة المبيعات
        document.querySelector('.summary-box span:nth-child(1) strong').textContent = formatCurrency(fixedCosts.rent);
        document.querySelector('.summary-box span:nth-child(2) strong').textContent = formatCurrency(fixedCosts.salaries);
        document.querySelector('.summary-box span:nth-child(3) strong').textContent = formatCurrency(fixedCosts.gas);
    }

    function addDailyExpense() {
        const desc = document.getElementById('dailyExpenseDesc').value.trim();
        const amount = parseInt(document.getElementById('dailyExpenseAmount').value) || 0;

        if (!desc || amount <= 0) {
            alert('يرجى إدخال وصف المصروف والمبلغ بشكل صحيح.');
            return;
        }

        dailyExpenses.push({ desc, amount, timestamp: new Date().toISOString() });
        saveDailyExpenses();
        renderDailyExpensesTable();

        document.getElementById('dailyExpenseDesc').value = '';
        document.getElementById('dailyExpenseAmount').value = '0';
    }

    function deleteDailyExpense(index) {
        if (confirm('هل أنت متأكد من حذف هذا المصروف اليومي؟')) {
            dailyExpenses.splice(index, 1);
            saveDailyExpenses();
            renderDailyExpensesTable();
        }
    }

    function renderDailyExpensesTable() {
        const tableBody = document.querySelector('#dailyExpensesTable tbody');
        tableBody.innerHTML = '';
        let totalExpenses = 0;

        dailyExpenses.forEach((expense, index) => {
            totalExpenses += expense.amount;
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${expense.desc}</td>
                <td>${formatCurrency(expense.amount)}</td>
                <td><button class="secondary" style="width:auto;margin:0;" onclick="deleteDailyExpense(${index})">حذف</button></td>
            `;
        });

        document.getElementById('totalDailyExpenses').textContent = formatCurrency(totalExpenses);
    }

    // ----------------------------------------------------------------
    // 7. وظائف الملخص والتقرير
    // ----------------------------------------------------------------
    function calculateSummary() {
        let totalMealsRevenue = 0;
        let totalDrinksRevenue = 0;
        let totalDeliveryRevenue = 0;
        let totalMaterialCost = 0;
        let totalFixedCostShare = 0;
        let mealSalesCount = {}; // لحساب الكمية المباعة لكل وجبة

        const mealFixedCostShare = calculateMealFixedCostShare();

        sales.forEach(sale => {
            const meal = meals.find(m => m.name === sale.mealName);
            if (!meal) return;

            // الإيرادات
            totalMealsRevenue += meal.price * sale.qty;
            totalDrinksRevenue += sale.drinksValue;
            totalDeliveryRevenue += sale.deliveryValue;

            // التكاليف
            totalMaterialCost += meal.materialCost * sale.qty;
            totalFixedCostShare += mealFixedCostShare * sale.qty;

            // تحليل الوجبات
            mealSalesCount[meal.name] = (mealSalesCount[meal.name] || 0) + sale.qty;
        });

        const totalRevenue = totalMealsRevenue + totalDrinksRevenue + totalDeliveryRevenue;
        const totalCost = totalMaterialCost + totalFixedCostShare;
        const totalDailyExpenses = parseInt(document.getElementById('totalDailyExpenses').textContent.replace(/,/g, '')) || 0;
        const netProfit = totalRevenue - totalCost - totalDailyExpenses;

        // تحديث جدول الملخص
        document.getElementById('sumTotalMeals').textContent = formatCurrency(totalMealsRevenue);
        document.getElementById('sumTotalDrinks').textContent = formatCurrency(totalDrinksRevenue);
        document.getElementById('sumTotalDelivery').textContent = formatCurrency(totalDeliveryRevenue);
        document.getElementById('sumTotalRevenue').textContent = formatCurrency(totalRevenue);
        document.getElementById('sumMaterialCost').textContent = formatCurrency(totalMaterialCost);
        document.getElementById('sumFixedCostShare').textContent = formatCurrency(Math.round(totalFixedCostShare));
        document.getElementById('sumTotalCost').textContent = formatCurrency(Math.round(totalCost));
        document.getElementById('sumNetProfit').textContent = formatCurrency(Math.round(netProfit));

        // تحديث جدول تحليل الوجبات
        const mealAnalysisTableBody = document.querySelector('#mealAnalysisTable tbody');
        mealAnalysisTableBody.innerHTML = '';
        for (const mealName in mealSalesCount) {
            const meal = meals.find(m => m.name === mealName);
            if (!meal) continue;

            const qty = mealSalesCount[mealName];
            const revenue = meal.price * qty;
            const singleMealTotalCost = meal.materialCost + mealFixedCostShare;
            const grossProfit = revenue - (singleMealTotalCost * qty);

            const row = mealAnalysisTableBody.insertRow();
            row.innerHTML = `
                <td>${mealName}</td>
                <td>${qty}</td>
                <td>${formatCurrency(revenue)}</td>
                <td>${formatCurrency(Math.round(grossProfit))}</td>
            `;
        }
    }

    function generateReport() {
        // إعادة حساب الملخص لضمان أحدث البيانات
        calculateSummary();

        const totalRevenue = parseInt(document.getElementById('sumTotalRevenue').textContent.replace(/,/g, '')) || 0;
        const materialCost = parseInt(document.getElementById('sumMaterialCost').textContent.replace(/,/g, '')) || 0;
        const fixedCostShare = parseInt(document.getElementById('sumFixedCostShare').textContent.replace(/,/g, '')) || 0;
        const dailyExpensesTotal = parseInt(document.getElementById('totalDailyExpenses').textContent.replace(/,/g, '')) || 0;
        const totalCostFinal = materialCost + fixedCostShare + dailyExpensesTotal;
        const netProfitFinal = totalRevenue - totalCostFinal;

        // تحديث جدول التقرير النهائي
        document.getElementById('repTotalRevenue').textContent = formatCurrency(totalRevenue);
        document.getElementById('repMaterialCost').textContent = formatCurrency(materialCost);
        document.getElementById('repFixedCostShare').textContent = formatCurrency(fixedCostShare);
        document.getElementById('repDailyExpenses').textContent = formatCurrency(dailyExpensesTotal);
        document.getElementById('repTotalCostFinal').textContent = formatCurrency(totalCostFinal);
        document.getElementById('repNetProfitFinal').textContent = formatCurrency(netProfitFinal);

        // إنشاء تفاصيل المبيعات كنص
        let salesDetails = "--- تفاصيل عمليات البيع ---\n";
        sales.forEach(sale => {
            const meal = meals.find(m => m.name === sale.mealName);
            if (!meal) return;
            const saleRevenue = meal.price * sale.qty + sale.drinksValue + sale.deliveryValue;
            salesDetails += `[${new Date(sale.timestamp).toLocaleTimeString('ar-SY')}] - ${sale.mealName} (x${sale.qty}) - النوع: ${sale.customerType} - الإيراد: ${formatCurrency(saleRevenue)} ل.س\n`;
        });

        salesDetails += "\n--- المصروفات النثرية اليومية ---\n";
        dailyExpenses.forEach(expense => {
            salesDetails += `[${new Date(expense.timestamp).toLocaleTimeString('ar-SY')}] - ${expense.desc}: ${formatCurrency(expense.amount)} ل.س\n`;
        });

        document.getElementById('salesReportDetails').textContent = salesDetails;
        alert('تم تحديث التقرير النهائي بنجاح.');
    }

    function exportReport() {
        const finalReportTable = document.getElementById('finalReportTable').outerHTML;
        const salesReportDetails = document.getElementById('salesReportDetails').textContent;
        const date = new Date().toLocaleDateString('ar-SY');
        const time = new Date().toLocaleTimeString('ar-SY');

        const reportText = `
تقرير نهاية اليوم - وجبة الكوتش
التاريخ: ${date} - الوقت: ${time}
--------------------------------------------------

${finalReportTable}

--------------------------------------------------
${salesReportDetails}
--------------------------------------------------
        `;

        // طريقة بسيطة لتنزيل النص كملف
        const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `تقرير_نهاية_اليوم_${date.replace(/\//g, '-')}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ----------------------------------------------------------------
    // 8. وظائف واجهة المستخدم (UI)
    // ----------------------------------------------------------------
    function setupTabs() {
        const tabButtons = document.querySelectorAll('.tab-btn');
        const sections = document.querySelectorAll('.section');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-target');

                // إزالة التفعيل من الكل
                tabButtons.forEach(btn => btn.classList.remove('active'));
                sections.forEach(sec => sec.classList.remove('active'));

                // تفعيل الزر والقسم المستهدف
                button.classList.add('active');
                document.getElementById(targetId).classList.add('active');

                // تحديث الملخص عند الانتقال إليه
                if (targetId === 'summary') {
                    calculateSummary();
                }
                // تحديث التقرير عند الانتقال إليه
                if (targetId === 'report') {
                    generateReport();
                }
            });
        });
    }

    // ----------------------------------------------------------------
    // 9. التهيئة عند تحميل الصفحة
    // ----------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        setupTabs();
        renderFixedCosts();
        renderMealsTable();
        renderSalesTable();
        renderDailyExpensesTable();
        // تفعيل القسم الأول افتراضياً
        document.getElementById('sales').classList.add('active');
    });
</script>

</body>
</html>
